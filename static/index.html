<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Schichtplan eingeben</title>
  </head>
  <body>
    <h1>Schichtplan eingeben</h1>

    <!-- Formular für Einzelne Schicht -->
    <form id="shift-form">
      <label for="name">Name:</label>
      <select id="name" name="name" required>
        <option value="">Bitte auswählen</option></select
      ><br /><br />

      <label for="date">Datum (YYYY-MM-DD):</label>
      <input type="date" id="date" name="date" required /><br /><br />

      <label for="shift_type">Schichttyp:</label>
      <select id="shift_type" name="shift_type" required>
        <option value="">Bitte auswählen</option></select
      ><br /><br />

      <input type="submit" value="Einzeln hinzufügen" />
    </form>

    <h2>Batch-Import</h2>

    <!-- Formular für Batch-Import -->
    <form id="batch-form">
      <label for="batch-name">Name:</label>
      <select id="batch-name" name="name" required>
        <option value="">Bitte auswählen</option></select
      ><br /><br />

      <label for="batch-shifts"
        >Schichten (Format: DD.MM:Schichttyp, z.B. 06.08:Früh):</label
      ><br />
      <textarea
        id="batch-shifts"
        name="batch-shifts"
        rows="10"
        cols="30"
        required
      ></textarea
      ><br /><br />

      <div id="available-shift-types">
        <!-- Hier werden die verfügbaren Schichten angezeigt -->
      </div>
      <br /><br />

      <input type="submit" value="Batch hinzufügen" />
    </form>

    <h2>Antwort:</h2>
    <pre id="response"></pre>

    <script>
      // Funktion zum Abrufen der Optionen für die Dropdown-Menüs
      function fetchOptions() {
        fetch("/api/options")
          .then((response) => response.json())
          .then((data) => {
            const nameSelect = document.getElementById("name");
            const batchNameSelect = document.getElementById("batch-name");

            // Namen hinzufügen
            data.names.forEach((name) => {
              const option = document.createElement("option");
              option.value = name;
              option.textContent = name;
              nameSelect.appendChild(option.cloneNode(true));
              batchNameSelect.appendChild(option.cloneNode(true));
            });

            // Schichttypen für Einzel-Schicht-Formular hinzufügen
            nameSelect.addEventListener("change", function () {
              const selectedName = this.value;
              if (selectedName) {
                fetchShiftTypes(selectedName.toLowerCase(), "single");
              } else {
                document.getElementById("shift_type").innerHTML =
                  '<option value="">Bitte auswählen</option>';
              }
            });
          });
      }

      // Funktion zum Abrufen der Schichttypen für den ausgewählten Namen
      function fetchShiftTypes(name, formType) {
        fetch(`/api/shift_types/${name}`)
          .then((response) => response.json())
          .then((data) => {
            if (formType === "batch") {
              const availableShiftTypesDiv = document.getElementById(
                "available-shift-types"
              );

              // Schichttypen als Text in der Batch-Import-Section anzeigen
              availableShiftTypesDiv.innerHTML =
                "<strong>Verfügbare Schichten:</strong><ul>";
              data.shift_types.forEach((shiftType) => {
                availableShiftTypesDiv.innerHTML += `<li>${shiftType}</li>`;
              });
              availableShiftTypesDiv.innerHTML += "</ul>";
            } else if (formType === "single") {
              const shiftTypeSelect = document.getElementById("shift_type");

              // Schichttypen für Einzel-Schicht-Formular aktualisieren
              shiftTypeSelect.innerHTML =
                '<option value="">Bitte auswählen</option>';
              data.shift_types.forEach((shiftType) => {
                const option = document.createElement("option");
                option.value = shiftType;
                option.textContent = shiftType;
                shiftTypeSelect.appendChild(option);
              });
            }
          });
      }

      // Optionen beim Laden der Seite abrufen
      document.addEventListener("DOMContentLoaded", fetchOptions);

      // Namen-Dropdown ändern (Batch-Import)
      document
        .getElementById("batch-name")
        .addEventListener("change", function () {
          const selectedName = this.value;
          if (selectedName) {
            fetchShiftTypes(selectedName.toLowerCase(), "batch");
          } else {
            document.getElementById("available-shift-types").innerHTML = "";
          }
        });

      // Einzelne Schicht hinzufügen
      document
        .getElementById("shift-form")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          const name = document.getElementById("name").value;
          const date = document.getElementById("date").value;
          const shiftType = document.getElementById("shift_type").value;

          fetch("/add_shifts", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify([
              {
                name: name,
                date: date,
                shift_type: shiftType,
              },
            ]),
          })
            .then((response) => response.json())
            .then((data) => {
              document.getElementById("response").textContent = JSON.stringify(
                data,
                null,
                2
              );
            });
        });

      // Batch-Import hinzufügen
      document
        .getElementById("batch-form")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          const name = document.getElementById("batch-name").value;
          const shiftsText = document.getElementById("batch-shifts").value;

          const currentYear = new Date().getFullYear(); // Aktuelles Jahr
          const shifts = shiftsText
            .trim()
            .split("\n")
            .map((line) => {
              const [date, shiftType] = line.split(":");
              const [day, month] = date.trim().split(".");
              const formattedDate = `${currentYear}-${month.padStart(
                2,
                "0"
              )}-${day.padStart(2, "0")}`;
              return {
                name: name,
                date: formattedDate,
                shift_type: shiftType.trim(),
              };
            });

          fetch("/add_shifts", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(shifts),
          })
            .then((response) => response.json())
            .then((data) => {
              document.getElementById("response").textContent = JSON.stringify(
                data,
                null,
                2
              );
            });
        });
    </script>
  </body>
</html>
